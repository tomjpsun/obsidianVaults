Today's working:

æ•™è‚²è¨“ç·´

trace igb driver:
	æ‰¾å‡º rx æ™‚è™•ç† PTP çš„éƒ¨åˆ†

```c
void igb_ptp_rx_pktstamp(struct igb_q_vector *q_vector,
                         unsigned char *va,
                         struct sk_buff *skb)

```

rx æ™‚,` igb_ptp_rx_pktstamp()`æœƒå¾ packet data header è£é¢æˆªå– timestamp æ”¾åˆ° skb è£é¢

```c
void igb_ptp_rx_pktstamp(struct igb_q_vector *q_vector,
                         unsigned char *va,
                         struct sk_buff *skb)
```

igb_clean_rx_irq() --> igb_process_skb_fields() --> igb_ptp_rx_pktstamp()
igb_process_skb_fields() : 
	this function checks the ring, descriptor, and packet information in order to populate the hash, checksum, VLAN, timestamp, protocol, and  other fields within the skb.
  igb_ptp_rx_pktstamp()
	   æ­¤å‡½æ•¸ç”¨æ–¼å¾å…§éƒ¨æš«å­˜å™¨ä¸­æª¢ç´¢æ™‚é–“æˆ³, ä¸¦å°‡å…¶å„²å­˜åœ¨ skb ä¸­ã€‚

## ä½¿ç”¨æ™‚æ©Ÿæœ‰ä½•ä¸åŒ?

 `igb_ptp_rx_pktstamp()` èˆ‡ `igb_ptp_rx_rgtstamp()` é›–ç„¶éƒ½**è®€å– timestamp**ï¼Œä½†è³‡æ–™ä¾†æºä¸åŒâ€”â€”ä¸€å€‹æ˜¯ **packet ä¸­çš„ timestamp**ï¼Œä¸€å€‹æ˜¯ **register è£¡çš„ timestamp**ï¼Œå®ƒå€‘çš„ä½¿ç”¨æ™‚æ©Ÿè·Ÿç¡¬é«”æ”¯æ´çš„å…©ç¨®æ¨¡å¼æœ‰é—œï¼š

---

## ğŸ§  ä½¿ç”¨æ™‚æ©Ÿå·®ç•°çš„æ ¸å¿ƒæ¦‚å¿µï¼š

**`TSIP`ï¼ˆTimestamp In Packetï¼‰bit æ˜¯å¦è¨­ç‚º 1ï¼Œæ±ºå®šäº† timestamp æ˜¯è¢«ã€Œå¯«é€²å°åŒ…ã€é‚„æ˜¯å¯«é€²ã€ŒRX registerã€ä¸­ã€‚**

---

## ğŸ”¹ `igb_ptp_rx_pktstamp()`ï¼šå°åŒ…å…§åµŒ timestamp

- **æ™‚æ©Ÿ**ï¼šå°åŒ…æœ¬èº«**æ”œå¸¶ timestamp**ï¼ˆä½æ–¼ packet å‰é¢ 8 bytesï¼‰ã€‚
    
- **æ¢ä»¶**ï¼šRX descriptor çš„ `TSIP` bit è¢«è¨­ç‚º 1ã€‚
    
- **ç‰¹è‰²**ï¼š
    
    - å¤šæ•¸ç”¨åœ¨æ”¯æ´ _packet-based timestamping_ çš„è£ç½®ã€‚
        
    - æ”¯æ´**é«˜ååé‡å ´æ™¯**ï¼Œå› ç‚º timestamp ä¸å¿…é€²å…¥ registerï¼Œå†é¡å¤–è®€å–ã€‚
        
    - ç”¨æ–¼ä¾‹å¦‚ï¼š1588v2 Annex Fã€Annex E çš„ç¡¬é«”å¯¦ä½œã€‚
        

---

## ğŸ”¹ `igb_ptp_rx_rgtstamp()`ï¼šregister ä¸­çš„ timestamp

- **æ™‚æ©Ÿ**ï¼šå°åŒ…çš„ timestamp å¯«é€²ç¡¬é«”çš„ `RXSTMP` registerï¼ˆå¯„å­˜å™¨ï¼‰ä¸­ã€‚
    
- **æ¢ä»¶**ï¼šRX descriptor çš„ `TS` bit è¢«è¨­ï¼Œä½† `TSIP` æ²’è¨­ï¼ˆå¦å‰‡å„ªå…ˆç”¨å°åŒ…ä¸­çš„ timestampï¼‰ã€‚
    
- **ç‰¹è‰²**ï¼š
    
    - å‚³çµ±æ¨¡å¼ï¼Œè¼ƒè€æˆ–è¼ƒä¾¿å®œçš„ç¡¬é«”å¯èƒ½åªæœ‰é€™å€‹æ–¹å¼ã€‚
        
    - æœ‰ç¡¬é«” buffer é™åˆ¶ï¼ˆé€šå¸¸åªæœ‰ä¸€å€‹ timestamp æš«å­˜ï¼Œéœ€ç›¡å¿«è™•ç†ï¼Œå¦å‰‡æœƒã€Œè“‹æ‰ã€ï¼‰ã€‚
        
    - driver é€šå¸¸ç”¨ watchdog ä¾†åµæ¸¬æ˜¯å¦æœ‰å¡ä½ä¸æ¸…çš„ timestampï¼ˆå°±æ˜¯ `igb_ptp_rx_hang()`ï¼‰ã€‚
        

---

## âœ… å…©ç¨®æ–¹å¼çš„å·®ç•°æ¯”è¼ƒï¼š

|ç‰¹æ€§|`igb_ptp_rx_pktstamp`|`igb_ptp_rx_rgtstamp`|
|---|---|---|
|Timestamp ä½ç½®|åœ¨ packet é–‹é ­ï¼ˆé€šå¸¸å‰ 8 bytesï¼‰|å¯«å…¥ `E1000_RXSTMP*` æš«å­˜å™¨|
|æè¿°ç¬¦ bit|`TSIP`|`TS`ï¼ˆä¸” `TSIP` æœªè¨­ï¼‰|
|æ•ˆç‡|é«˜ï¼ˆç„¡éœ€é¡å¤– register è®€å–ï¼‰|ä½ï¼ˆè¦æ‰‹å‹•è®€å–å¯„å­˜å™¨ï¼‰|
|å®¹éŒ¯|å¤šå€‹å°åŒ…å¯åŒæ™‚å« timestamp|register è‹¥æœªå³æ™‚è™•ç†å¯èƒ½ overflow|
|ç¡¬é«”éœ€æ±‚|æ”¯æ´ packet timestamp insertion|å‚³çµ±å¤§å¤šæ”¯æ´|
|Driver è™•ç†æ–¹å¼|å‰é›¢å°åŒ…å‰å° timestamp|è®€ register, æ¸…é™¤æœ‰æ•ˆä½|

---

## ğŸ”š ç¸½çµ

ä½ å¯ä»¥é€™æ¨£è¨˜ï¼š

- è‹¥å°åŒ…è‡ªå·±å¸¶ timestamp â‡’ ç”¨ `igb_ptp_rx_pktstamp()`ã€‚
    
- è‹¥å°åŒ…æ²’æœ‰ï¼Œä½†ç¡¬é«”å¦å­˜ä¸€ä»½åˆ°æš«å­˜å™¨ â‡’ ç”¨ `igb_ptp_rx_rgtstamp()`ã€‚
    
- è‹¥å…©è€…åŒæ™‚å­˜åœ¨ï¼Œ**å°åŒ…å…§çš„ timestamp å„ªå…ˆä½¿ç”¨**ï¼ˆé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ code æœƒ `if TSIP... else if TS`ï¼‰ã€‚
    

---
